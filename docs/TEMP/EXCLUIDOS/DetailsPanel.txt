import React, { useState } from 'react';
import { ArrowLeft, FileText, Download, FileSpreadsheet } from 'lucide-react';
import * as XLSX from 'xlsx';
import ResizablePanel from './ResizablePanel';
import './Panels.css';

const DetailsPanel = ({ data, onBack }) => {
  const [isExportingJSON, setIsExportingJSON] = useState(false);
  const [isExportingExcel, setIsExportingExcel] = useState(false);

  // ==========================================
  // FUNÇÃO DE EXPORTAÇÃO PARA JSON
  // ==========================================
  const exportToJSON = () => {
    if (!data) {
      alert('Nenhum dado para exportar');
      return;
    }

    setIsExportingJSON(true);

    setTimeout(() => {
      try {
        // Converter dados para JSON formatado
        const jsonString = JSON.stringify(data, null, 2);
        
        // Criar Blob com o JSON
        const blob = new Blob([jsonString], { type: 'application/json' });
        
        // Criar URL temporária
        const url = window.URL.createObjectURL(blob);
        
        // Criar link temporário para download
        const link = document.createElement('a');
        link.href = url;
        
        // Nome do arquivo
        const now = new Date();
        const timestamp = now.toISOString().slice(0, 19).replace(/:/g, '-');
        const convenioSiafi = data.convenio_siafi || data.SIAFI || 'operacao';
        link.download = `Detalhes_Operacao_${convenioSiafi}_${timestamp}.json`;
        
        // Simular clique
        document.body.appendChild(link);
        link.click();
        
        // Limpar
        document.body.removeChild(link);
        window.URL.revokeObjectURL(url);
      } catch (error) {
        console.error('Erro ao exportar:', error);
        alert('Erro ao exportar arquivo. Tente novamente.');
      } finally {
        setIsExportingJSON(false);
      }
    }, 300);
  };

  // ==========================================
  // FUNÇÃO DE EXPORTAÇÃO PARA EXCEL
  // ==========================================
  const exportToExcel = () => {
    if (!data) {
      alert('Nenhum dado para exportar');
      return;
    }

    setIsExportingExcel(true);

    setTimeout(() => {
      try {
        // Função auxiliar para achatar objeto aninhado
        const flattenObject = (obj, prefix = '') => {
          return Object.keys(obj).reduce((acc, key) => {
            const value = obj[key];
            const newKey = prefix ? `${prefix}.${key}` : key;
            
            if (value === null || value === undefined) {
              acc[newKey] = '';
            } else if (typeof value === 'object' && !Array.isArray(value)) {
              // Se for objeto, achatar recursivamente
              Object.assign(acc, flattenObject(value, newKey));
            } else if (Array.isArray(value)) {
              // Se for array, converter para string
              acc[newKey] = value.join(', ');
            } else {
              acc[newKey] = value;
            }
            
            return acc;
          }, {});
        };

        // Achatar dados
        const flatData = flattenObject(data);

        // Converter para array de objetos (formato de tabela)
        const tableData = Object.keys(flatData).map(key => ({
          'Campo': key,
          'Valor': flatData[key]
        }));

        // Criar worksheet
        const worksheet = XLSX.utils.json_to_sheet(tableData);

        // Ajustar largura das colunas
        worksheet['!cols'] = [
          { wch: 40 },  // Campo (largo para campos aninhados)
          { wch: 60 }   // Valor
        ];

        // Criar workbook
        const workbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(workbook, worksheet, 'Detalhes');

        // Nome do arquivo
        const now = new Date();
        const timestamp = now.toISOString().slice(0, 19).replace(/:/g, '-');
        const convenioSiafi = data.convenio_siafi || data.SIAFI || 'operacao';
        const filename = `Detalhes_Operacao_${convenioSiafi}_${timestamp}.xlsx`;

        // Salvar
        XLSX.writeFile(workbook, filename);
      } catch (error) {
        console.error('Erro ao exportar:', error);
        alert('Erro ao exportar arquivo. Tente novamente.');
      } finally {
        setIsExportingExcel(false);
      }
    }, 300);
  };

  if (!data) {
    return (
      <ResizablePanel className="full-height">
        <div className="details-panel">
          <div className="details-empty-state">
            <FileText className="details-empty-icon" />
            <p className="details-empty-text">
              Nenhuma operação selecionada. Faça uma busca para visualizar os detalhes.
            </p>
          </div>
        </div>
      </ResizablePanel>
    );
  }

  return (
    <ResizablePanel className="full-height">
      <div className="details-panel">
        <div className="details-header">
          <button
            onClick={onBack}
            className="details-back-button"
          >
            <ArrowLeft className="details-back-icon" />
            Voltar
          </button>
          <h2 className="details-title">Detalhes da Operação</h2>
          
          {/* Botões de Exportação */}
          <div className="details-export-buttons">
            <button
              onClick={exportToExcel}
              className="comments-btn comments-btn-add"
              disabled={isExportingExcel}
              title="Exportar detalhes em formato Excel (tabela campo-valor)"
              style={{ marginRight: '0.5rem' }}
            >
              <FileSpreadsheet className="comments-btn-icon" />
              {isExportingExcel ? 'Exportando...' : 'Excel'}
            </button>

            <button
              onClick={exportToJSON}
              className="comments-btn comments-btn-add"
              disabled={isExportingJSON}
              title="Exportar detalhes completos em JSON"
            >
              <Download className="comments-btn-icon" />
              {isExportingJSON ? 'Exportando...' : 'JSON'}
            </button>
          </div>
        </div>

        <div className="details-content">
          <pre className="details-json">
            {JSON.stringify(data, null, 2)}
          </pre>
        </div>
      </div>
    </ResizablePanel>
  );
};

export default DetailsPanel;
